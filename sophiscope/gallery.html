<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
  <meta name="theme-color" content="#000000">
  <meta name="description" content="Sophiscope - Galerie des sophismes. Explorez et apprenez à identifier les erreurs de raisonnement.">
  
  <!-- Open Graph / Social Media -->
  <meta property="og:title" content="Sophiscope - Galerie">
  <meta property="og:description" content="Explorez les sophismes et apprenez à les identifier.">
  <meta property="og:image" content="/assets/img/sophiscope-images/sophiscope_main_image.jpg">
  <meta property="og:type" content="website">
  
  <!-- Favicon -->
  <link rel="icon" type="image/x-icon" href="/assets/img/ui/favicon.ico">
  
  <!-- Stylesheet -->
  <link rel="stylesheet" href="/assets/sophiscope/sophiscope.css">
  
  <title>Sophiscope - Galerie</title>
</head>
<body class="sophiscope-page sophiscope-page--gallery">
  <div class="sophiscope-container sophiscope-container--gallery">
    
    <!-- Gallery Header -->
    <header class="gallery-header">
      <h1 class="gallery-title">SOPHISCOPE</h1>
      <p class="gallery-subtitle">Sélectionnez un sophisme</p>
    </header>
    
    <!-- Main Gallery Content -->
    <main class="gallery-main" role="main">
      <div class="gallery-wrapper">
        <div class="gallery-grid" id="gallery-grid">
          <!-- Cards will be generated by JS -->
        </div>
        <!-- Bottom fade gradient to indicate more content -->
        <div class="gallery-fade" aria-hidden="true"></div>
      </div>
    </main>
    
    <!-- Card Detail Modal -->
    <div 
      class="card-modal" 
      id="card-modal" 
      role="dialog" 
      aria-modal="true" 
      aria-labelledby="card-modal-title"
      aria-hidden="true"
    >
      <div class="card-modal__overlay" id="card-modal-overlay"></div>
      <div class="card-modal__content" id="card-modal-content">
        <!-- Left: Poster Image -->
        <div class="card-modal__poster">
          <img 
            class="card-modal__image" 
            id="card-modal-image"
            src="" 
            alt=""
            loading="eager"
          >
          <h2 class="card-modal__title" id="card-modal-title"></h2>
        </div>
        
        <!-- Right: Description Panel -->
        <div class="card-modal__panel">
          <div class="card-modal__panel-inner">
            <p class="card-modal__description" id="card-modal-description"></p>
            
            <div class="card-modal__example">
              <h3 class="card-modal__example-title">Exemple 1</h3>
              <p class="card-modal__example-text" id="card-modal-example1"></p>
            </div>
            
            <div class="card-modal__example">
              <h3 class="card-modal__example-title">Exemple 2</h3>
              <p class="card-modal__example-text" id="card-modal-example2"></p>
            </div>
            
            <a 
              href="#" 
              class="card-modal__cta" 
              id="card-modal-cta"
              role="button"
            >
              Démarrer l'entraînement
            </a>
          </div>
        </div>
      </div>
    </div>
    
    <!-- Back Button (contextual: closes modal or goes back) -->
    <footer class="gallery-footer" role="contentinfo">
      <button 
        type="button"
        class="gallery-btn-back"
        id="btn-back"
        aria-label="Retour"
      >
        <svg class="gallery-btn-back__icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
          <polyline points="15 18 9 12 15 6"></polyline>
        </svg>
        <span class="gallery-btn-back__label">RETOUR</span>
      </button>
    </footer>
    
  </div>

  <!-- JavaScript -->
  <script>
    (function() {
      'use strict';
      
      // Configuration
      const JSON_URL = '/assets/img/sophiscope-cards/cards.json';
      const SKELETON_COUNT = 12;
      const HIGH_PRIORITY_COUNT = 6;
      const TRANSITION_SOUND_URL = '/assets/sophiscope/sophiscope-sounds/sophiscope_transition.mp3';
      
      // Audio
      const transitionSound = new Audio(TRANSITION_SOUND_URL);
      transitionSound.volume = 0.5;
      
      // DOM Elements
      const galleryGrid = document.getElementById('gallery-grid');
      const btnBack = document.getElementById('btn-back');
      const cardModal = document.getElementById('card-modal');
      const cardModalOverlay = document.getElementById('card-modal-overlay');
      const cardModalContent = document.getElementById('card-modal-content');
      const cardModalImage = document.getElementById('card-modal-image');
      const cardModalTitle = document.getElementById('card-modal-title');
      const cardModalDescription = document.getElementById('card-modal-description');
      const cardModalExample1 = document.getElementById('card-modal-example1');
      const cardModalExample2 = document.getElementById('card-modal-example2');
      const cardModalCta = document.getElementById('card-modal-cta');
      
      // State
      let cardsData = null;
      let basePaths = null;
      let currentCard = null;
      let isModalOpen = false;
      let previousFocusElement = null;
      
      // =======================================================================
      // INITIALIZATION
      // =======================================================================
      
      async function init() {
        if (!galleryGrid) return;
        
        showSkeletons();
        
        try {
          const response = await fetch(JSON_URL);
          if (!response.ok) {
            throw new Error(`HTTP ${response.status}`);
          }
          
          const data = await response.json();
          basePaths = data.meta.basePaths;
          cardsData = data.cards;
          
          cardsData.sort((a, b) => {
            if (a.order !== undefined && b.order !== undefined) {
              return a.order - b.order;
            }
            return a.title.localeCompare(b.title, 'fr');
          });
          
          renderCards();
          
        } catch (error) {
          console.error('Sophiscope: Failed to load cards', error);
          showError();
        }
        
        // Setup event listeners
        setupModalListeners();
        setupBackButton();
      }
      
      // =======================================================================
      // GALLERY RENDERING
      // =======================================================================
      
      function showSkeletons() {
        galleryGrid.innerHTML = '';
        const fragment = document.createDocumentFragment();
        
        for (let i = 0; i < SKELETON_COUNT; i++) {
          const skeleton = createSkeletonCard();
          fragment.appendChild(skeleton);
        }
        
        galleryGrid.appendChild(fragment);
      }
      
      function createSkeletonCard() {
        const card = document.createElement('article');
        card.className = 'gallery-card gallery-card--skeleton';
        card.setAttribute('aria-hidden', 'true');
        
        card.innerHTML = `
          <div class="gallery-card__visual">
            <div class="gallery-card__placeholder gallery-card__placeholder--loading">
              <div class="gallery-card__skeleton-shimmer"></div>
            </div>
          </div>
          <div class="gallery-card__title gallery-card__title--skeleton">&nbsp;</div>
        `;
        
        return card;
      }
      
      function renderCards() {
        galleryGrid.innerHTML = '';
        const fragment = document.createDocumentFragment();
        
        cardsData.forEach((cardData, index) => {
          const card = createCard(cardData, index);
          fragment.appendChild(card);
        });
        
        galleryGrid.appendChild(fragment);
      }
      
      function createCard(data, index) {
        const { id, slug, title, category, images, training } = data;
        const isHighPriority = index < HIGH_PRIORITY_COUNT;
        
        // Check if training is available
        const hasTraining = training && training.items && training.items.length > 0;
        
        const card = document.createElement('article');
        card.className = hasTraining ? 'gallery-card gallery-card--has-training' : 'gallery-card';
        card.setAttribute('data-id', id);
        card.setAttribute('data-slug', slug);
        card.setAttribute('data-category', category);
        card.setAttribute('tabindex', '0');
        card.setAttribute('role', 'button');
        card.setAttribute('aria-label', title + (hasTraining ? ' - Entraînement disponible' : ''));
        
        const srcW400 = basePaths.w400 + images.w400;
        const srcW800 = basePaths.w800 + images.w800;
        const srcW1200 = basePaths.w1200 + images.w1200;
        const srcset = `${srcW400} 400w, ${srcW800} 800w, ${srcW1200} 1200w`;
        const sizes = '(max-width: 767px) 46vw, (max-width: 1024px) 30vw, 220px';
        
        // Build training badge HTML
        const trainingBadge = hasTraining 
          ? '<p class="gallery-card__training-badge">Entraînement disponible</p>' 
          : '';
        
        card.innerHTML = `
          <div class="gallery-card__visual">
            <img 
              class="gallery-card__image"
              src="${srcW800}"
              srcset="${srcset}"
              sizes="${sizes}"
              alt="${title}"
              loading="${isHighPriority ? 'eager' : 'lazy'}"
              decoding="async"
              ${isHighPriority ? 'fetchpriority="high"' : ''}
            >
            <div class="gallery-card__placeholder gallery-card__placeholder--fallback" aria-hidden="true">
              <svg class="gallery-card__placeholder-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                <rect x="3" y="3" width="18" height="18" rx="2" ry="2"/>
                <circle cx="8.5" cy="8.5" r="1.5"/>
                <polyline points="21 15 16 10 5 21"/>
              </svg>
              <span class="gallery-card__placeholder-text">IMAGE NON DISPONIBLE</span>
            </div>
          </div>
          <h2 class="gallery-card__title">${title.toUpperCase()}</h2>
          ${trainingBadge}
        `;
        
        const img = card.querySelector('.gallery-card__image');
        img.addEventListener('error', function() {
          this.style.display = 'none';
          const fallback = card.querySelector('.gallery-card__placeholder--fallback');
          if (fallback) {
            fallback.classList.add('gallery-card__placeholder--visible');
          }
        });
        
        card.addEventListener('click', function() {
          openModal(data);
        });
        
        card.addEventListener('keydown', function(e) {
          if (e.key === 'Enter' || e.key === ' ') {
            e.preventDefault();
            openModal(data);
          }
        });
        
        return card;
      }
      
      function showError() {
        galleryGrid.innerHTML = `
          <div class="gallery-error">
            <svg class="gallery-error__icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <circle cx="12" cy="12" r="10"/>
              <line x1="12" y1="8" x2="12" y2="12"/>
              <line x1="12" y1="16" x2="12.01" y2="16"/>
            </svg>
            <p class="gallery-error__text">Impossible de charger les cartes</p>
            <button class="gallery-error__retry" onclick="location.reload()">Réessayer</button>
          </div>
        `;
      }
      
      // =======================================================================
      // MODAL FUNCTIONS
      // =======================================================================
      
      function openModal(cardData) {
        currentCard = cardData;
        isModalOpen = true;
        previousFocusElement = document.activeElement;
        
        // Play transition sound
        transitionSound.currentTime = 0;
        transitionSound.play().catch(err => {
          // Autoplay may be blocked, ignore silently
        });
        
        // Populate modal content
        const { title, slug, images, content } = cardData;
        
        // Extract content fields (with fallbacks)
        const definition = (content && content.definition) ? content.definition : null;
        const examples = (content && content.examples) ? content.examples : [];
        
        // Image (prefer w1200, fallback to w800)
        const imageSrc = basePaths.w1200 + images.w1200;
        cardModalImage.src = imageSrc;
        cardModalImage.alt = title;
        
        // Title
        cardModalTitle.textContent = title.toUpperCase();
        
        // Description (with fallback)
        cardModalDescription.textContent = definition || '(Description à venir…)';
        
        // Examples (with fallback)
        const ex1 = examples[0] || '(Exemple 1 à venir…)';
        const ex2 = examples[1] || '(Exemple 2 à venir…)';
        cardModalExample1.textContent = ex1;
        cardModalExample2.textContent = ex2;
        
        // CTA link
        cardModalCta.href = `/sophiscope/training.html?card=${encodeURIComponent(slug)}`;
        
        // Show modal
        cardModal.classList.add('card-modal--open');
        cardModal.setAttribute('aria-hidden', 'false');
        document.body.classList.add('modal-open');
        
        // Focus management
        setTimeout(() => {
          cardModalContent.focus();
        }, 100);
      }
      
      function closeModal() {
        if (!isModalOpen) return;
        
        currentCard = null;
        isModalOpen = false;
        
        // Hide modal
        cardModal.classList.remove('card-modal--open');
        cardModal.setAttribute('aria-hidden', 'true');
        document.body.classList.remove('modal-open');
        
        // Restore focus
        if (previousFocusElement) {
          previousFocusElement.focus();
          previousFocusElement = null;
        }
      }
      
      function setupModalListeners() {
        // Close on overlay click
        cardModalOverlay.addEventListener('click', closeModal);
        
        // Close on ESC key
        document.addEventListener('keydown', function(e) {
          if (e.key === 'Escape' && isModalOpen) {
            e.preventDefault();
            closeModal();
          }
        });
        
        // Prevent modal content click from closing
        cardModalContent.addEventListener('click', function(e) {
          e.stopPropagation();
        });
        
        // Make modal content focusable for focus trap
        cardModalContent.setAttribute('tabindex', '-1');
      }
      
      // =======================================================================
      // BACK BUTTON (CONTEXTUAL)
      // =======================================================================
      
      function setupBackButton() {
        if (!btnBack) return;
        
        btnBack.addEventListener('click', function(e) {
          e.preventDefault();
          
          if (isModalOpen) {
            // Modal is open: close it
            closeModal();
          } else {
            // Modal is closed: go back to home
            window.location.href = '/sophiscope/';
          }
        });
      }
      
      // Initialize
      init();
      
    })();
  </script>
</body>
</html>
