<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IGI - Indice Global d'Instabilit√©</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üìä</text></svg>">
    <style>
        @font-face {
            font-family: 'NexaRustSlab';
            src: url('/assets/fonts/NexaRustSlab-Trial-BlackShadow3.woff2') format('woff2'),
                 url('/assets/fonts/NexaRustSlab-Trial-BlackShadow3.woff') format('woff');
            font-weight: bold;
            font-style: normal;
            font-display: swap;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html, body {
            width: 100%;
            height: 100%;
            overflow: hidden;
            font-family: 'MS Sans Serif', Tahoma, sans-serif;
        }

        body {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            background: #000000;
            color: #ffffff;
        }

        .igi-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            padding: 20px;
        }

        .igi-value {
            font-size: clamp(80px, 25vw, 300px);
            font-weight: bold;
            font-family: 'NexaRustSlab', 'Courier New', Courier, monospace;
            letter-spacing: 0.05em;
            line-height: 1;
            color: #ffffff;
            text-shadow: 0 0 20px rgba(255, 255, 255, 0.3);
        }

        .igi-date {
            font-size: clamp(11px, 1.5vw, 14px);
            color: #666666;
            margin-top: 12px;
            letter-spacing: 0.05em;
            font-family: 'Courier New', Courier, monospace;
        }

        .igi-label {
            font-size: clamp(12px, 2vw, 18px);
            color: #808080;
            margin-top: 20px;
            letter-spacing: 0.2em;
            text-transform: uppercase;
        }

        .igi-translations {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 6px;
            margin-top: 16px;
        }

        .igi-translation {
            font-size: clamp(10px, 1.5vw, 14px);
            color: #555555;
            letter-spacing: 0.1em;
            font-family: system-ui, -apple-system, sans-serif;
        }

        .igi-error {
            font-size: 12px;
            color: #666666;
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            font-family: 'MS Sans Serif', Tahoma, sans-serif;
        }

        .igi-loading {
            font-size: clamp(40px, 10vw, 100px);
            color: #404040;
            animation: pulse 1.5s ease-in-out infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 0.4; }
            50% { opacity: 1; }
        }

        /* Lien retour discret */
        .back-link {
            position: fixed;
            top: 15px;
            left: 15px;
            font-size: 11px;
            color: #555555;
            text-decoration: none;
            padding: 4px 8px;
            border: 1px solid #333333;
            transition: all 0.2s ease;
        }

        .back-link:hover {
            color: #888888;
            border-color: #555555;
        }

        /* √âchelle d'information */
        .igi-scale {
            margin-top: 30px;
            padding: 12px 20px;
            border: 1px solid #333333;
            border-radius: 4px;
            background: rgba(255, 255, 255, 0.03);
        }

        .igi-scale-item {
            font-size: clamp(9px, 1.2vw, 12px);
            color: #666666;
            margin: 4px 0;
            display: flex;
            justify-content: center;
            gap: 8px;
        }

        .igi-scale-item .peace {
            color: hsl(120, 65%, 45%);
        }

        .igi-scale-item .chaos {
            color: hsl(0, 90%, 40%);
        }

        .igi-scale-item .arrow {
            color: #444444;
        }

        /* Conteneur des boutons √† droite */
        .info-buttons-container {
            position: fixed;
            right: 0;
            top: 50%;
            transform: translateY(-50%);
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        /* Bouton info √† droite */
        .info-button {
            background: #222222;
            border: 1px solid #444444;
            border-right: none;
            color: #888888;
            padding: 15px 10px;
            font-size: 14px;
            cursor: pointer;
            border-radius: 8px 0 0 8px;
            transition: all 0.2s ease;
            writing-mode: vertical-rl;
            text-orientation: mixed;
            letter-spacing: 0.1em;
        }

        .info-button:hover {
            background: #333333;
            color: #cccccc;
            padding-right: 15px;
        }

        .credits-button {
            font-size: 12px;
        }

        /* Modale info */
        .info-modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.85);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .info-modal-overlay.show {
            display: flex;
        }

        .info-modal {
            background: #1a1a1a;
            border: 1px solid #444444;
            border-radius: 8px;
            max-width: 700px;
            max-height: 85vh;
            width: 90%;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .info-modal-header {
            background: #222222;
            padding: 12px 16px;
            border-bottom: 1px solid #333333;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .info-modal-title {
            color: #cccccc;
            font-size: 14px;
            font-weight: bold;
        }

        .info-modal-close {
            background: none;
            border: 1px solid #555555;
            color: #888888;
            width: 24px;
            height: 24px;
            cursor: pointer;
            font-size: 16px;
            border-radius: 4px;
            transition: all 0.2s ease;
        }

        .info-modal-close:hover {
            background: #333333;
            color: #ffffff;
        }

        .info-modal-content {
            padding: 20px;
            overflow-y: auto;
            color: #aaaaaa;
            font-size: 12px;
            line-height: 1.6;
        }

        .info-modal-content h3 {
            color: #cccccc;
            font-size: 13px;
            margin: 16px 0 8px 0;
            padding-bottom: 4px;
            border-bottom: 1px solid #333333;
        }

        .info-modal-content h3:first-child {
            margin-top: 0;
        }

        .info-modal-content p {
            margin: 8px 0;
        }

        .info-modal-content ul {
            margin: 8px 0;
            padding-left: 20px;
        }

        .info-modal-content li {
            margin: 4px 0;
        }

        .info-modal-content code {
            background: #2a2a2a;
            padding: 2px 6px;
            border-radius: 3px;
            font-family: 'Courier New', monospace;
            color: #88cc88;
        }

        .info-modal-content .formula {
            background: #252525;
            padding: 12px;
            border-radius: 4px;
            margin: 12px 0;
            text-align: center;
            font-family: 'Courier New', monospace;
            color: #88aacc;
        }

        /* Ic√¥ne en haut √† droite */
        .igi-icon {
            position: fixed;
            top: 15px;
            right: 15px;
            width: 32px;
            height: 32px;
            opacity: 0.7;
            transition: opacity 0.2s ease;
        }

        .igi-icon:hover {
            opacity: 1;
        }

        /* Graphique en arri√®re-plan */
        .igi-background-chart {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 50;
            pointer-events: none;
            padding: 60px 80px 60px 40px; /* marges: top, right (pour boutons), bottom, left */
            box-sizing: border-box;
        }

        .igi-background-chart svg {
            width: 100%;
            height: 100%;
            pointer-events: none;
        }

        .igi-background-chart svg circle {
            pointer-events: all;
        }

        .chart-line {
            fill: none;
            stroke: rgba(120, 120, 120, 0.6);
            stroke-width: 2.5;
            stroke-linecap: round;
            stroke-linejoin: round;
        }

        .chart-area {
            fill: url(#chartGradient);
            opacity: 0.2;
        }

        .chart-grid-line {
            stroke: rgba(70, 70, 70, 0.4);
            stroke-width: 1;
            stroke-dasharray: 4, 4;
        }

        .chart-axis-label {
            fill: rgba(120, 120, 120, 0.6);
            font-family: 'Courier New', monospace;
            font-size: 10px;
        }

        .chart-dot {
            fill: rgba(140, 140, 140, 0.7);
            cursor: pointer;
            pointer-events: all;
            transition: all 0.15s ease;
        }

        .chart-dot:hover {
            fill: rgba(200, 200, 200, 1);
            r: 6;
        }

        .chart-dot-current {
            fill: rgba(180, 180, 180, 0.85);
            cursor: pointer;
            pointer-events: all;
            transition: all 0.15s ease;
        }

        .chart-dot-current:hover {
            fill: rgba(230, 230, 230, 1);
        }

        /* Tooltip pour le graphique */
        .chart-tooltip {
            position: fixed;
            background: rgba(30, 30, 30, 0.95);
            border: 1px solid #555555;
            border-radius: 4px;
            padding: 8px 12px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            color: #cccccc;
            pointer-events: none;
            z-index: 100;
            opacity: 0;
            transform: translateY(5px);
            transition: opacity 0.15s ease, transform 0.15s ease;
            white-space: nowrap;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.5);
        }

        .chart-tooltip.visible {
            opacity: 1;
            transform: translateY(0);
        }

        .chart-tooltip-day {
            color: #888888;
            font-size: 10px;
            margin-bottom: 4px;
        }

        .chart-tooltip-value {
            font-size: 16px;
            font-weight: bold;
            color: #ffffff;
        }
    </style>
</head>
<body>
    <!-- Graphique en arri√®re-plan -->
    <div class="igi-background-chart" id="background-chart"></div>
    
    <!-- Tooltip pour le graphique -->
    <div class="chart-tooltip" id="chart-tooltip">
        <div class="chart-tooltip-day"></div>
        <div class="chart-tooltip-value"></div>
    </div>

    <a href="/" class="back-link">‚Üê Retour</a>
    <img src="/img/igi.png" alt="IGI" class="igi-icon">

    <div class="igi-container">
        <div class="igi-value" id="igi-value">
            <span class="igi-loading">...</span>
        </div>
        <div class="igi-date" id="igi-date"></div>
        <div class="igi-label">Indice Global d'Instabilit√©</div>
        <div class="igi-translations">
            <span class="igi-translation">Global Instability Index</span>
            <span class="igi-translation">ÂÖ®ÁêÉ‰∏çÁ®≥ÂÆöÊåáÊï∞</span>
            <span class="igi-translation">–ì–ª–æ–±–∞–ª—å–Ω—ã–π –∏–Ω–¥–µ–∫—Å –Ω–µ—Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç–∏</span>
            <span class="igi-translation" dir="rtl">ŸÖÿ§ÿ¥ÿ± ÿπÿØŸÖ ÿßŸÑÿßÿ≥ÿ™ŸÇÿ±ÿßÿ± ÿßŸÑÿπÿßŸÑŸÖŸä</span>
        </div>

        <!-- √âchelle multilingue -->
        <div class="igi-scale">
            <div class="igi-scale-item"><span class="peace">0 = Paix mondiale</span> <span class="arrow">‚Üí</span> <span class="chaos">1000 = Chaos absolu</span></div>
            <div class="igi-scale-item"><span class="peace">0 = World peace</span> <span class="arrow">‚Üí</span> <span class="chaos">1000 = Absolute chaos</span></div>
            <div class="igi-scale-item"><span class="peace">0 = ‰∏ñÁïåÂíåÂπ≥</span> <span class="arrow">‚Üí</span> <span class="chaos">1000 = ÁªùÂØπÊ∑∑‰π±</span></div>
            <div class="igi-scale-item"><span class="peace">0 = –ú–∏—Ä–æ–≤–æ–π –º–∏—Ä</span> <span class="arrow">‚Üí</span> <span class="chaos">1000 = –ê–±—Å–æ–ª—é—Ç–Ω—ã–π —Ö–∞–æ—Å</span></div>
            <div class="igi-scale-item" dir="rtl"><span class="peace">Ÿ† = ÿ≥ŸÑÿßŸÖ ÿπÿßŸÑŸÖŸä</span> <span class="arrow">‚Üê</span> <span class="chaos">Ÿ°Ÿ†Ÿ†Ÿ† = ŸÅŸàÿ∂Ÿâ ŸÖÿ∑ŸÑŸÇÿ©</span></div>
        </div>
    </div>

    <!-- Boutons info -->
    <div class="info-buttons-container">
        <button class="info-button today-button" id="today-button" title="Contexte du jour">üìã Aujourd'hui</button>
        <button class="info-button" id="info-button" title="En savoir plus">‚Ñπ M√©thodologie</button>
        <button class="info-button credits-button" id="credits-button" title="Cr√©dits">¬© Cr√©dits</button>
    </div>

    <!-- Modale Aujourd'hui -->
    <div class="info-modal-overlay" id="today-modal-overlay">
        <div class="info-modal">
            <div class="info-modal-header">
                <span class="info-modal-title">üìã Contexte du jour</span>
                <button class="info-modal-close" id="today-modal-close">√ó</button>
            </div>
            <div class="info-modal-content">
                <p id="today-note-content" style="font-size: 1.1em; line-height: 1.6;">Chargement...</p>
            </div>
        </div>
    </div>

    <!-- Modale info -->
    <div class="info-modal-overlay" id="info-modal-overlay">
        <div class="info-modal">
            <div class="info-modal-header">
                <span class="info-modal-title">Indice Global d'Instabilit√© (IGI) ‚Äî M√©thodologie</span>
                <button class="info-modal-close" id="info-modal-close">√ó</button>
            </div>
            <div class="info-modal-content">
                <h3>Qu'est-ce que l'IGI ?</h3>
                <p>
                    L'Indice Global d'Instabilit√© (IGI) est un indicateur synth√©tique exp√©rimental, 
                    mis √† jour quotidiennement. Il vise √† fournir une lecture instantan√©e du niveau 
                    d'instabilit√© mondiale √† partir d'un ensemble de signaux agr√©g√©s.
                </p>
                <p>
                    <strong>√âchelle :</strong> <code>0</code> = paix mondiale ‚Üí <code>1000</code> = chaos absolu.
                </p>

                <h3>M√©thode de calcul</h3>
                <p>
                    L'indice est calcul√© √† partir des contributions pond√©r√©es de plusieurs pays ou r√©gions 
                    selon leur niveau d'instabilit√© quotidien.
                </p>
                <div class="formula">
                    IGI = (Œ£ contribution_pond√©r√©e / 15) √ó 1000
                </div>
                <p>O√π chaque contribution pond√©r√©e est :</p>
                <div class="formula">
                    contribution = poids_fragilit√© √ó score_instabilit√©_quotidien
                </div>

                <h3>Composantes du calcul</h3>
                <ul>
                    <li><strong>Poids de fragilit√© (FIG)</strong> : bas√© sur le Fragile States Index et le poids g√©opolitique du pays/r√©gion</li>
                    <li><strong>Score d'instabilit√© quotidien</strong> : √©valuation bas√©e sur les √©v√©nements du jour (√©chelle Fibonacci : 1, 2, 3, 5, 8, 13...)</li>
                    <li><strong>Bonus de chronicit√©</strong> : les crises prolong√©es re√ßoivent un facteur suppl√©mentaire</li>
                </ul>

                <h3>Sources de donn√©es</h3>
                <ul>
                    <li>International Crisis Group ‚Äî 10 Conflicts to Watch</li>
                    <li>IRC Emergency Watchlist</li>
                    <li>ACLED Conflict Watchlist</li>
                    <li>CFR Conflicts to Watch</li>
                    <li>Fragile States Index & OECD States of Fragility</li>
                    <li>Couverture m√©diatique internationale (Reuters, Al Jazeera, BBC, etc.)</li>
                </ul>

                <h3>Limites et avertissements</h3>
                <p>
                    Cet indice est fourni <strong>√† titre informatif et exp√©rimental</strong>. 
                    Il ne constitue pas une mesure scientifique valid√©e et ne doit pas √™tre utilis√© 
                    comme base pour des d√©cisions critiques. Les pond√©rations et m√©thodes peuvent √©voluer.
                </p>
            </div>
        </div>
    </div>

    <!-- Modale cr√©dits -->
    <div class="info-modal-overlay" id="credits-modal-overlay">
        <div class="info-modal">
            <div class="info-modal-header">
                <span class="info-modal-title">Cr√©dits</span>
                <button class="info-modal-close" id="credits-modal-close">√ó</button>
            </div>
            <div class="info-modal-content">
                <h3>Ic√¥nes</h3>
                <p>
                    <a href="https://www.flaticon.com/fr/icones-gratuites/presentation" title="presentation ic√¥nes" target="_blank" rel="noopener noreferrer" style="color: #88aacc;">Presentation ic√¥nes cr√©√©es par Sumitsaengtong - Flaticon</a>
                </p>
            </div>
        </div>
    </div>

    <div class="igi-error" id="igi-error" style="display: none;"></div>

    <script>
        (function() {
            'use strict';

            const IGI_JSON_PATH = '/assets/data/igi.json';
            const valueEl = document.getElementById('igi-value');
            const errorEl = document.getElementById('igi-error');
            const dateEl = document.getElementById('igi-date');

            /**
             * Affiche la date du jour format√©e
             */
            function displayCurrentDate() {
                const now = new Date();
                const options = { 
                    weekday: 'long', 
                    year: 'numeric', 
                    month: 'long', 
                    day: 'numeric' 
                };
                // Format en fran√ßais
                const dateFr = now.toLocaleDateString('fr-FR', options);
                // Premi√®re lettre en majuscule
                dateEl.textContent = dateFr.charAt(0).toUpperCase() + dateFr.slice(1);
            }

            // Afficher la date imm√©diatement
            displayCurrentDate();

            /**
             * Affiche une erreur discr√®te en bas de page
             */
            function showError(message) {
                valueEl.innerHTML = '<span class="igi-loading">‚Äî</span>';
                errorEl.textContent = message;
                errorEl.style.display = 'block';
            }

            /**
             * Formate le nombre selon les r√®gles :
             * - Entier : pas de d√©cimales
             * - D√©cimal : max 2 d√©cimales
             */
            function formatValue(num) {
                if (Number.isInteger(num)) {
                    return num.toString();
                }
                // Arrondi √† 2 d√©cimales max, supprime les z√©ros inutiles
                return parseFloat(num.toFixed(2)).toString();
            }

            /**
             * Extrait la valeur IGI du JSON avec strat√©gie tol√©rante
             * G√®re les structures imbriqu√©es et plates
             */
            function extractValue(data) {
                if (data === null || typeof data !== 'object') {
                    return null;
                }

                // 1. Structure imbriqu√©e : global_instability_index.value
                if (data.global_instability_index && typeof data.global_instability_index === 'object') {
                    const gii = data.global_instability_index;
                    if (typeof gii.value === 'number' && !isNaN(gii.value)) {
                        return gii.value;
                    }
                }

                // 2. Strat√©gie tol√©rante pour structure plate : cl√©s dans l'ordre de priorit√©
                const keys = ['value', 'igi', 'index'];
                
                for (const key of keys) {
                    if (key in data && typeof data[key] === 'number' && !isNaN(data[key])) {
                        return data[key];
                    }
                }

                return null;
            }

            /**
             * Charge et affiche l'IGI
             */
            let igiJsonData = null; // Stockage des donn√©es pour le graphique
            
            async function loadIGI() {
                try {
                    const response = await fetch(IGI_JSON_PATH);

                    if (!response.ok) {
                        throw new Error('network');
                    }

                    let data;
                    try {
                        data = await response.json();
                    } catch (e) {
                        throw new Error('json');
                    }

                    // Stocker les donn√©es pour le graphique
                    igiJsonData = data;
                    
                    // Mettre √† jour la note "Aujourd'hui"
                    const noteEl = document.getElementById('today-note-content');
                    if (noteEl && data.global_instability_index && data.global_instability_index.note) {
                        noteEl.textContent = data.global_instability_index.note;
                    } else if (noteEl) {
                        noteEl.textContent = 'Aucune note disponible pour aujourd\'hui.';
                    }

                    const value = extractValue(data);

                    if (value === null) {
                        throw new Error('missing');
                    }

                    // Affichage du nombre avec couleur selon le niveau
                    valueEl.textContent = formatValue(value);
                    valueEl.style.color = getColorForValue(value);
                    valueEl.style.textShadow = `0 0 30px ${getColorForValue(value, 0.4)}`;
                    
                    // Rendre le graphique apr√®s chargement des donn√©es
                    renderBackgroundChart();

                } catch (error) {
                    console.error('Erreur IGI:', error);
                    showError('IGI indisponible');
                }
            }

            /**
             * Retourne une couleur en fonction de la valeur IGI (0-1000)
             * D√©grad√©: Vert (0) ‚Üí Jaune (250-400) ‚Üí Orange (500-650) ‚Üí Rouge (1000)
             * Utilise HSL pour un d√©grad√© naturel
             */
            function getColorForValue(value, alpha = 1) {
                // Clamp entre 0 et 1000
                const v = Math.max(0, Math.min(1000, value));
                
                // Palette de couleurs par paliers de ~50 points
                // Format: [seuil, hue, saturation%, lightness%]
                const colorStops = [
                    [0,    120, 65, 45],   // Vert fonc√©
                    [50,   115, 60, 48],   // Vert
                    [100,  110, 55, 50],   // Vert clair
                    [150,  100, 55, 52],   // Vert p√¢le
                    [200,  90,  58, 52],   // Vert-jaune
                    [250,  75,  62, 52],   // Jaune-vert
                    [300,  60,  70, 52],   // Jaune p√¢le
                    [350,  54,  80, 52],   // Jaune
                    [400,  48,  90, 50],   // Jaune soleil
                    [450,  42,  92, 50],   // Jaune-orange
                    [500,  36,  92, 50],   // Orange clair
                    [550,  30,  90, 48],   // Orange
                    [600,  24,  88, 46],   // Orange fonc√©
                    [650,  18,  85, 45],   // Orange-rouge
                    [700,  12,  82, 44],   // Rouge-orange
                    [750,  8,   80, 43],   // Rouge clair
                    [800,  4,   78, 42],   // Rouge
                    [850,  2,   80, 40],   // Rouge fonc√©
                    [900,  0,   85, 38],   // Rouge √©carlate
                    [950,  0,   90, 35],   // Rouge √©carlate intense
                    [1000, 0,   95, 30]    // Rouge √©carlate profond
                ];

                // Trouver les deux paliers encadrant la valeur
                let lower = colorStops[0];
                let upper = colorStops[colorStops.length - 1];

                for (let i = 0; i < colorStops.length - 1; i++) {
                    if (v >= colorStops[i][0] && v < colorStops[i + 1][0]) {
                        lower = colorStops[i];
                        upper = colorStops[i + 1];
                        break;
                    }
                }

                // Interpolation lin√©aire entre les deux paliers
                const range = upper[0] - lower[0];
                const t = range > 0 ? (v - lower[0]) / range : 0;

                const h = Math.round(lower[1] + (upper[1] - lower[1]) * t);
                const s = Math.round(lower[2] + (upper[2] - lower[2]) * t);
                const l = Math.round(lower[3] + (upper[3] - lower[3]) * t);

                if (alpha < 1) {
                    return `hsla(${h}, ${s}%, ${l}%, ${alpha})`;
                }
                return `hsl(${h}, ${s}%, ${l}%)`;
            }

            // Chargement au d√©marrage
            loadIGI();

            // ========== GRAPHIQUE EN ARRI√àRE-PLAN ==========
            function renderBackgroundChart() {
                const chartContainer = document.getElementById('background-chart');
                if (!chartContainer) return;

                // R√©cup√©rer l'historique depuis le JSON charg√©
                let igiData = [];
                if (igiJsonData && igiJsonData.history && Array.isArray(igiJsonData.history)) {
                    // Convertir le format { date: "2026-01-01", value: 365 } en { day: 1, value: 365 }
                    igiData = igiJsonData.history.map(entry => {
                        const date = new Date(entry.date);
                        return {
                            day: date.getDate(),
                            value: entry.value
                        };
                    });
                }
                
                // Si pas de donn√©es, ne pas afficher le graphique
                if (igiData.length === 0) {
                    console.warn('Aucune donn√©e historique IGI disponible');
                    return;
                }

                // Jours du mois en cours (janvier = 31 jours)
                const daysInMonth = 31;
                const currentDay = new Date().getDate();

                // Dimensions du graphique
                const padding = { top: 30, right: 30, bottom: 40, left: 50 };
                
                // Valeurs min/max pour l'axe Y (avec marge)
                const dataMin = Math.min(...igiData.map(d => d.value));
                const dataMax = Math.max(...igiData.map(d => d.value));
                
                // Fonction pour calculer les paliers dynamiques
                function calculateTicks(min, max) {
                    const range = max - min;
                    
                    // D√©terminer l'intervalle appropri√© selon la plage
                    let interval;
                    if (range <= 30) {
                        interval = 5;
                    } else if (range <= 60) {
                        interval = 10;
                    } else if (range <= 150) {
                        interval = 25;
                    } else if (range <= 300) {
                        interval = 50;
                    } else if (range <= 600) {
                        interval = 100;
                    } else {
                        interval = 200;
                    }
                    
                    // Arrondir min vers le bas et max vers le haut au multiple de l'intervalle
                    const tickMin = Math.floor(min / interval) * interval;
                    const tickMax = Math.ceil(max / interval) * interval;
                    
                    // G√©n√©rer les ticks
                    const ticks = [];
                    for (let tick = tickMin; tick <= tickMax; tick += interval) {
                        ticks.push(tick);
                    }
                    
                    return { ticks, tickMin, tickMax };
                }
                
                const { ticks: yTicks, tickMin, tickMax } = calculateTicks(dataMin, dataMax);
                
                // Utiliser les bornes arrondies pour l'axe Y (avec petite marge)
                const minValue = tickMin - (yTicks[1] - yTicks[0]) * 0.2;
                const maxValue = tickMax + (yTicks[1] - yTicks[0]) * 0.5;

                // Cr√©ation du SVG
                const svgNS = 'http://www.w3.org/2000/svg';
                const svg = document.createElementNS(svgNS, 'svg');
                svg.setAttribute('viewBox', '0 0 1000 600');
                svg.setAttribute('preserveAspectRatio', 'xMidYMid meet');

                // D√©grad√© pour l'aire sous la courbe
                const defs = document.createElementNS(svgNS, 'defs');
                const gradient = document.createElementNS(svgNS, 'linearGradient');
                gradient.setAttribute('id', 'chartGradient');
                gradient.setAttribute('x1', '0%');
                gradient.setAttribute('y1', '0%');
                gradient.setAttribute('x2', '0%');
                gradient.setAttribute('y2', '100%');
                
                const stop1 = document.createElementNS(svgNS, 'stop');
                stop1.setAttribute('offset', '0%');
                stop1.setAttribute('stop-color', 'rgba(100, 100, 100, 0.3)');
                
                const stop2 = document.createElementNS(svgNS, 'stop');
                stop2.setAttribute('offset', '100%');
                stop2.setAttribute('stop-color', 'rgba(50, 50, 50, 0)');
                
                gradient.appendChild(stop1);
                gradient.appendChild(stop2);
                defs.appendChild(gradient);
                svg.appendChild(defs);

                // Dimensions utiles
                const chartWidth = 1000 - padding.left - padding.right;
                const chartHeight = 600 - padding.top - padding.bottom;

                // Fonctions de mise √† l'√©chelle
                const xScale = (day) => padding.left + ((day - 1) / (daysInMonth - 1)) * chartWidth;
                const yScale = (value) => padding.top + ((maxValue - value) / (maxValue - minValue)) * chartHeight;

                // Lignes de grille horizontales (paliers calcul√©s dynamiquement)
                yTicks.forEach(tick => {
                    const y = yScale(tick);
                    if (y > padding.top && y < 600 - padding.bottom) {
                        const line = document.createElementNS(svgNS, 'line');
                        line.setAttribute('x1', padding.left);
                        line.setAttribute('y1', y);
                        line.setAttribute('x2', 1000 - padding.right);
                        line.setAttribute('y2', y);
                        line.setAttribute('class', 'chart-grid-line');
                        svg.appendChild(line);

                        // Labels Y
                        const label = document.createElementNS(svgNS, 'text');
                        label.setAttribute('x', padding.left - 10);
                        label.setAttribute('y', y + 4);
                        label.setAttribute('text-anchor', 'end');
                        label.setAttribute('class', 'chart-axis-label');
                        label.textContent = tick;
                        svg.appendChild(label);
                    }
                });

                // Labels X (jours) - afficher quelques jours
                const xTickDays = [1, 5, 10, 15, 20, 25, 31];
                xTickDays.forEach(day => {
                    const x = xScale(day);
                    const label = document.createElementNS(svgNS, 'text');
                    label.setAttribute('x', x);
                    label.setAttribute('y', 600 - padding.bottom + 20);
                    label.setAttribute('text-anchor', 'middle');
                    label.setAttribute('class', 'chart-axis-label');
                    label.textContent = day;
                    svg.appendChild(label);
                });

                // Cr√©er le chemin de la courbe
                let pathD = '';
                let areaD = '';
                
                igiData.forEach((point, index) => {
                    const x = xScale(point.day);
                    const y = yScale(point.value);
                    
                    if (index === 0) {
                        pathD += `M ${x} ${y}`;
                        areaD += `M ${x} ${600 - padding.bottom} L ${x} ${y}`;
                    } else {
                        pathD += ` L ${x} ${y}`;
                        areaD += ` L ${x} ${y}`;
                    }
                });

                // Fermer l'aire
                const lastPoint = igiData[igiData.length - 1];
                areaD += ` L ${xScale(lastPoint.day)} ${600 - padding.bottom} Z`;

                // Aire sous la courbe
                const area = document.createElementNS(svgNS, 'path');
                area.setAttribute('d', areaD);
                area.setAttribute('class', 'chart-area');
                svg.appendChild(area);

                // Ligne de la courbe
                const path = document.createElementNS(svgNS, 'path');
                path.setAttribute('d', pathD);
                path.setAttribute('class', 'chart-line');
                svg.appendChild(path);

                // Tooltip
                const tooltip = document.getElementById('chart-tooltip');
                const tooltipDay = tooltip.querySelector('.chart-tooltip-day');
                const tooltipValue = tooltip.querySelector('.chart-tooltip-value');

                // Points sur la courbe
                igiData.forEach((point, index) => {
                    const x = xScale(point.day);
                    const y = yScale(point.value);
                    const circle = document.createElementNS(svgNS, 'circle');
                    circle.setAttribute('cx', x);
                    circle.setAttribute('cy', y);
                    circle.setAttribute('r', index === igiData.length - 1 ? 5 : 3);
                    circle.setAttribute('class', index === igiData.length - 1 ? 'chart-dot-current' : 'chart-dot');
                    
                    // Stocker les donn√©es sur l'√©l√©ment
                    circle.dataset.day = point.day;
                    circle.dataset.value = point.value;

                    // √âv√©nements de survol
                    circle.addEventListener('mouseenter', function(e) {
                        const day = this.dataset.day;
                        const value = this.dataset.value;
                        
                        // Formater la date
                        const dayNum = parseInt(day);
                        const suffix = dayNum === 1 ? 'er' : '';
                        tooltipDay.textContent = `${dayNum}${suffix} janvier 2026`;
                        tooltipValue.textContent = value;
                        
                        // Positionner la tooltip
                        const rect = this.getBoundingClientRect();
                        tooltip.style.left = (rect.left + rect.width / 2 - tooltip.offsetWidth / 2) + 'px';
                        tooltip.style.top = (rect.top - tooltip.offsetHeight - 10) + 'px';
                        
                        // Afficher
                        tooltip.classList.add('visible');
                        
                        // Agrandir le point
                        this.setAttribute('r', index === igiData.length - 1 ? 7 : 5);
                    });

                    circle.addEventListener('mouseleave', function() {
                        tooltip.classList.remove('visible');
                        this.setAttribute('r', index === igiData.length - 1 ? 5 : 3);
                    });

                    svg.appendChild(circle);
                });

                // Label "Janvier 2026"
                const monthLabel = document.createElementNS(svgNS, 'text');
                monthLabel.setAttribute('x', 1000 - padding.right);
                monthLabel.setAttribute('y', 600 - padding.bottom + 35);
                monthLabel.setAttribute('text-anchor', 'end');
                monthLabel.setAttribute('class', 'chart-axis-label');
                monthLabel.textContent = 'Janvier 2026';
                svg.appendChild(monthLabel);

                chartContainer.appendChild(svg);
            }

            // Gestion de la modale Aujourd'hui
            const todayButton = document.getElementById('today-button');
            const todayModalOverlay = document.getElementById('today-modal-overlay');
            const todayModalClose = document.getElementById('today-modal-close');

            todayButton.addEventListener('click', function() {
                todayModalOverlay.classList.add('show');
            });

            todayModalClose.addEventListener('click', function() {
                todayModalOverlay.classList.remove('show');
            });

            todayModalOverlay.addEventListener('click', function(e) {
                if (e.target === todayModalOverlay) {
                    todayModalOverlay.classList.remove('show');
                }
            });

            // Gestion de la modale info
            const infoButton = document.getElementById('info-button');
            const infoModalOverlay = document.getElementById('info-modal-overlay');
            const infoModalClose = document.getElementById('info-modal-close');

            infoButton.addEventListener('click', function() {
                infoModalOverlay.classList.add('show');
            });

            infoModalClose.addEventListener('click', function() {
                infoModalOverlay.classList.remove('show');
            });

            // Fermer en cliquant sur l'overlay (hors modale)
            infoModalOverlay.addEventListener('click', function(e) {
                if (e.target === infoModalOverlay) {
                    infoModalOverlay.classList.remove('show');
                }
            });

            // Gestion de la modale cr√©dits
            const creditsButton = document.getElementById('credits-button');
            const creditsModalOverlay = document.getElementById('credits-modal-overlay');
            const creditsModalClose = document.getElementById('credits-modal-close');

            creditsButton.addEventListener('click', function() {
                creditsModalOverlay.classList.add('show');
            });

            creditsModalClose.addEventListener('click', function() {
                creditsModalOverlay.classList.remove('show');
            });

            creditsModalOverlay.addEventListener('click', function(e) {
                if (e.target === creditsModalOverlay) {
                    creditsModalOverlay.classList.remove('show');
                }
            });

            // Fermer avec Escape (toutes les modales)
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Escape') {
                    if (todayModalOverlay.classList.contains('show')) {
                        todayModalOverlay.classList.remove('show');
                    }
                    if (infoModalOverlay.classList.contains('show')) {
                        infoModalOverlay.classList.remove('show');
                    }
                    if (creditsModalOverlay.classList.contains('show')) {
                        creditsModalOverlay.classList.remove('show');
                    }
                }
            });
        })();
    </script>

    <!-- GoatCounter Analytics -->
    <script data-goatcounter="https://forgecitizens.goatcounter.com/count"
            async src="//gc.zgo.at/count.js"></script>
</body>
</html>
